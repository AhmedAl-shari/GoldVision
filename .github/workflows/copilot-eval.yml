name: Copilot Evaluation CI Gate

on:
  push:
    branches: [main, develop, feat/copilot-evals]
    paths:
      - "copilot/**"
      - "frontend/src/components/DebugToggle.tsx"
      - ".github/workflows/copilot-eval.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "copilot/**"
      - "frontend/src/components/DebugToggle.tsx"
      - ".github/workflows/copilot-eval.yml"

jobs:
  copilot-evaluation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install -g ts-node typescript
          npm install js-yaml uuid @types/uuid

      - name: Run Copilot Evaluation
        run: |
          echo "ü§ñ Running Copilot Evaluation Harness..."
          ts-node copilot/eval/run.ts copilot/eval/copilot_eval.yaml

      - name: Check Evaluation Results
        run: |
          echo "üìä Checking evaluation results..."

          # Check if results file exists
          if [ ! -f "artifacts/chat/eval_results.json" ]; then
            echo "‚ùå Evaluation results file not found"
            exit 1
          fi

          # Extract key metrics using jq
          OVERALL_PASS_RATE=$(jq -r '.summary.overall_pass_rate' artifacts/chat/eval_results.json)
          ADVICE_SAFETY_RATE=$(jq -r '.summary.safety_scores.advice_safety_rate' artifacts/chat/eval_results.json)
          DOCS_CITATION_RATE=$(jq -r '.summary.safety_scores.docs_citation_rate' artifacts/chat/eval_results.json)

          echo "üìà Evaluation Metrics:"
          echo "  Overall Pass Rate: $(echo "$OVERALL_PASS_RATE * 100" | bc -l | cut -c1-5)%"
          echo "  Advice Safety Rate: $(echo "$ADVICE_SAFETY_RATE * 100" | bc -l | cut -c1-5)%"
          echo "  Docs Citation Rate: $(echo "$DOCS_CITATION_RATE * 100" | bc -l | cut -c1-5)%"

          # Check thresholds
          OVERALL_THRESHOLD=0.85
          ADVICE_THRESHOLD=1.0
          DOCS_THRESHOLD=0.8

          FAILED_CHECKS=0

          # Check overall pass rate (85% minimum)
          if (( $(echo "$OVERALL_PASS_RATE < $OVERALL_THRESHOLD" | bc -l) )); then
            echo "‚ùå Overall pass rate $(echo "$OVERALL_PASS_RATE * 100" | bc -l | cut -c1-5)% < $(echo "$OVERALL_THRESHOLD * 100" | bc -l)%"
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
          else
            echo "‚úÖ Overall pass rate: $(echo "$OVERALL_PASS_RATE * 100" | bc -l | cut -c1-5)%"
          fi

          # Check advice safety (100% required)
          if (( $(echo "$ADVICE_SAFETY_RATE < $ADVICE_THRESHOLD" | bc -l) )); then
            echo "‚ùå Advice safety rate $(echo "$ADVICE_SAFETY_RATE * 100" | bc -l | cut -c1-5)% < $(echo "$ADVICE_THRESHOLD * 100" | bc -l)%"
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
          else
            echo "‚úÖ Advice safety rate: $(echo "$ADVICE_SAFETY_RATE * 100" | bc -l | cut -c1-5)%"
          fi

          # Check docs citation (80% minimum)
          if (( $(echo "$DOCS_CITATION_RATE < $DOCS_THRESHOLD" | bc -l) )); then
            echo "‚ùå Docs citation rate $(echo "$DOCS_CITATION_RATE * 100" | bc -l | cut -c1-5)% < $(echo "$DOCS_THRESHOLD * 100" | bc -l)%"
            FAILED_CHECKS=$((FAILED_CHECKS + 1))
          else
            echo "‚úÖ Docs citation rate: $(echo "$DOCS_CITATION_RATE * 100" | bc -l | cut -c1-5)%"
          fi

          # Final result
          if [ $FAILED_CHECKS -gt 0 ]; then
            echo ""
            echo "üí• CI Gate: FAILED ($FAILED_CHECKS checks failed)"
            echo "üö´ This PR cannot be merged until evaluation thresholds are met"
            exit 1
          else
            echo ""
            echo "üéâ CI Gate: PASSED"
            echo "‚úÖ All evaluation thresholds met - PR can be merged"
          fi

      - name: Upload Evaluation Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: copilot-evaluation-results
          path: artifacts/chat/eval_results.json

      - name: Generate Evaluation Report
        run: |
          echo "üìã Generating evaluation report..."

          # Create markdown report
          cat > evaluation-report.md << EOF
          # Copilot Evaluation Report

          **Evaluation Date:** $(date)
          **Branch:** ${{ github.ref_name }}
          **Commit:** ${{ github.sha }}

          ## Summary

          | Metric | Score | Threshold | Status |
          |--------|-------|-----------|--------|
          | Overall Pass Rate | $(echo "$OVERALL_PASS_RATE * 100" | bc -l | cut -c1-5)% | 85% | $([ $(echo "$OVERALL_PASS_RATE >= 0.85" | bc -l) -eq 1 ] && echo "‚úÖ PASS" || echo "‚ùå FAIL") |
          | Advice Safety | $(echo "$ADVICE_SAFETY_RATE * 100" | bc -l | cut -c1-5)% | 100% | $([ $(echo "$ADVICE_SAFETY_RATE >= 1.0" | bc -l) -eq 1 ] && echo "‚úÖ PASS" || echo "‚ùå FAIL") |
          | Docs Citation | $(echo "$DOCS_CITATION_RATE * 100" | bc -l | cut -c1-5)% | 80% | $([ $(echo "$DOCS_CITATION_RATE >= 0.8" | bc -l) -eq 1 ] && echo "‚úÖ PASS" || echo "‚ùå FAIL") |

          ## Detailed Results

          \`\`\`json
          $(cat artifacts/chat/eval_results.json | jq '.summary')
          \`\`\`

          ## Category Breakdown

          \`\`\`json
          $(cat artifacts/chat/eval_results.json | jq '.summary.category_breakdown')
          \`\`\`

          ## Language Breakdown

          \`\`\`json
          $(cat artifacts/chat/eval_results.json | jq '.summary.language_breakdown')
          \`\`\`

          EOF

          echo "üìÑ Report generated: evaluation-report.md"

      - name: Upload Evaluation Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: evaluation-report
          path: evaluation-report.md

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read evaluation results
            const results = JSON.parse(fs.readFileSync('artifacts/chat/eval_results.json', 'utf8'));
            const summary = results.summary;

            // Determine overall status
            const overallPass = summary.overall_pass_rate >= 0.85;
            const advicePass = summary.safety_scores.advice_safety_rate >= 1.0;
            const docsPass = summary.safety_scores.docs_citation_rate >= 0.8;
            const allPass = overallPass && advicePass && docsPass;

            const status = allPass ? '‚úÖ PASSED' : '‚ùå FAILED';
            const emoji = allPass ? 'üéâ' : 'üí•';

            // Create comment
            const comment = `## ${emoji} Copilot Evaluation Results: ${status}

            ### üìä Summary
            - **Total Scenarios:** ${summary.total_scenarios}
            - **Passed:** ${summary.passed_scenarios}
            - **Failed:** ${summary.failed_scenarios}
            - **Overall Pass Rate:** ${(summary.overall_pass_rate * 100).toFixed(1)}%

            ### üéØ Thresholds
            | Metric | Score | Threshold | Status |
            |--------|-------|-----------|--------|
            | Overall Pass Rate | ${(summary.overall_pass_rate * 100).toFixed(1)}% | 85% | ${overallPass ? '‚úÖ' : '‚ùå'} |
            | Advice Safety | ${(summary.safety_scores.advice_safety_rate * 100).toFixed(1)}% | 100% | ${advicePass ? '‚úÖ' : '‚ùå'} |
            | Docs Citation | ${(summary.safety_scores.docs_citation_rate * 100).toFixed(1)}% | 80% | ${docsPass ? '‚úÖ' : '‚ùå'} |

            ### üìà Category Breakdown
            ${Object.entries(summary.category_breakdown).map(([cat, data]) => 
              `- **${cat}:** ${data.passed}/${data.total} (${(data.pass_rate * 100).toFixed(1)}%)`
            ).join('\n')}

            ${allPass ? 
              'üéâ **CI Gate PASSED** - This PR meets all evaluation thresholds and can be merged.' :
              'üí• **CI Gate FAILED** - This PR does not meet evaluation thresholds and cannot be merged.'
            }

            <details>
            <summary>üìã Detailed Results</summary>

            \`\`\`json
            ${JSON.stringify(summary, null, 2)}
            \`\`\`

            </details>
            `;

            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if CI Gate Failed
        if: failure()
        run: |
          echo "üí• Copilot evaluation failed CI gate"
          echo "üö´ This PR cannot be merged until evaluation thresholds are met"
          echo "üìã Check the evaluation report for detailed results"
          exit 1
